- name: Deploy to VM
  run: |
    # Write SSH private key
    printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/ssh_key
    chmod 600 ~/ssh_key

    # Connect and deploy
    ssh -o StrictHostKeyChecking=no -i ~/ssh_key Mrkhan@20.187.144.240 << 'EOF'
      set -e

      cd ~/ci-cd-new
      git config pull.rebase false
      git pull origin main

      # âœ… Load your environment manually
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

      # Also include global npm binaries (in case pm2/pnpm installed globally)
      export PATH=\$PATH:/usr/local/bin:\$HOME/.nvm/versions/node/$(node -v)/bin:\$HOME/.local/bin

      echo "Using Node.js version: $(node -v)"
      echo "Using npm version: $(npm -v)"
      echo "Using pnpm version: $(pnpm -v)"
      echo "Using pm2 version: $(pm2 -v)"

      pnpm install
      pnpm run build

      pm2 restart web || pm2 start dist/web.js --name web
      pm2 restart http-server || pm2 start dist/http-server.js --name http-server
      pm2 restart ws-server || pm2 start dist/ws-server.js --name ws-server
    EOF