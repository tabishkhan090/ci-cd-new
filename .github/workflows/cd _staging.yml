name: Deploy to staging

on:
  push:
    branches: [ main ]

jobs:
  redeploy_everything:
    runs-on: ubuntu-latest
    name: Deploying everything to the staging cluster
    steps:
      - name: Deploy to VM
        run: |
          # Write SSH private key
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/ssh_key
          chmod 600 ~/ssh_key
          ssh -v -o StrictHostKeyChecking=no -i ~/ssh_key Mrkhan@20.187.144.240 exit

          # Connect and deploy
          ssh -i ~/ssh_key Mrkhan@20.187.144.240 << 'EOF'
            cd ~/ci-cd-new
            git pull origin main

            # Load NVM environment
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

            # Extend PATH to include Node, npm, pnpm, pm2
            export PATH=$PATH:$HOME/.nvm/versions/node/v22.13.1/bin:/usr/local/bin:$HOME/.local/bin

            echo "Node version: $(node -v)"
            echo "npm version: $(npm -v)"
            echo "pnpm version: $(pnpm -v)"
            echo "pm2 version: $(pm2 -v)"

            pnpm install
            pnpm run build

            pm2 restart web
            pm2 restart http-server
            pm2 restart ws-server
          EOF
